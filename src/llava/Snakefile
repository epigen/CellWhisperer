"""
"""

include: "../shared/config.smk"

import pandas as pd

# For snakemake efficiency, extract the samples once and store them
if not os.path.exists("./gsva_samples.csv"):
    ARCHS4_GSVA_SAMPLES = pd.read_parquet(PROJECT_DIR / config["paths"]["gsva"]["result"].format(dataset="archs4_geo")).set_index("Unnamed: 0").drop(columns=["library"]).columns
    # store GSVA samples
    with open("./gsva_samples.csv", "w") as f:
        f.write("\n".join(ARCHS4_GSVA_SAMPLES.to_list()))
else:
    ARCHS4_GSVA_SAMPLES = pd.read_csv("./gsva_samples.csv", header=None).iloc[:, 0]

NUM_COMPLEX_SAMPLES = 5000
NUM_DETAILED_SAMPLES = 10000
CONVERSATION_START = NUM_COMPLEX_SAMPLES + NUM_DETAILED_SAMPLES
COMPLEX_SAMPLES = ARCHS4_GSVA_SAMPLES.to_list()[:NUM_COMPLEX_SAMPLES]
DETAILED_SAMPLES = ARCHS4_GSVA_SAMPLES.to_list()[NUM_COMPLEX_SAMPLES:CONVERSATION_START]
scattergather:
    split=128

MODELS = [model_path for model_name, model_path in config["model_name_path_map"].items() if "cellwhisperer" in model_name]
BASE_MODEL = config["model_name_path_map"]["llava_base_llm"]


include: "../shared/rules/dataset_processing.smk"
include: "../shared/rules/training_sample_weights.smk"
include: "../shared/rules/genesets.smk"
include: "../shared/rules/gsva.smk"
include: "rules/dataset.smk"
include: "rules/training.smk"

rule all:
    input:
        expand(rules.finetune_llava.output.output_dir,
               base_model=[BASE_MODEL],
               model=["uce",
                      "scgpt",
                      "geneformer",
                      config["model_name_path_map"]["cellwhisperer_uce"],
                      config["model_name_path_map"]["cellwhisperer_scgpt"],
                      config["model_name_path_map"]["cellwhisperer_geneformer"]
                      ],
               llava_dataset=["_celltype", "_default"]
               ),
        expand(rules.finetune_llava.output.output_dir,
               base_model=[BASE_MODEL],
               model=["uce",  # doesn't matter which one, as it is unused..
                      ],
               llava_dataset=["_top50genescelltype"]
               )

    default_target: True
